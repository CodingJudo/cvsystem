import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// This script lives in `scripts/` so repoRoot is one level up.
const repoRoot = path.resolve(__dirname, '..');
const themesDir = path.join(repoRoot, 'public', 'themes', 'cv');
const outputFile = path.join(repoRoot, 'src', 'lib', 'print-themes.ts');

function labelFromFilename(filename) {
  const base = filename.replace(/\.css$/i, '');
  const withoutPrefix = base.replace(/^print-/i, '');
  return withoutPrefix
    .split(/[-_]+/g)
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ');
}

async function main() {
  let entries = [];
  try {
    entries = await fs.readdir(themesDir, { withFileTypes: true });
  } catch (err) {
    console.error(`Theme directory not found: ${themesDir}`);
    throw err;
  }

  const themeFiles = entries
    .filter((e) => e.isFile())
    .map((e) => e.name)
    .filter((name) => name.toLowerCase().endsWith('.css'))
    .sort((a, b) => a.localeCompare(b));

  const themes = themeFiles.map((file) => {
    const id = file.replace(/\.css$/i, '');
    return {
      id,
      label: labelFromFilename(file),
      href: `/themes/cv/${file}`,
      className: `printTheme--${id.replace(/^print-/i, '')}`,
    };
  });

  const contents = `// This file is auto-generated by scripts/generate-print-theme-manifest.mjs
// Do not edit manually.

export type PrintTheme = {
  id: string;
  label: string;
  href: string;
  className: string;
};

export const PRINT_THEMES: PrintTheme[] = ${JSON.stringify(themes, null, 2)} as const;

export const DEFAULT_PRINT_THEME_ID: PrintTheme['id'] =
  PRINT_THEMES.find((t) => t.id === 'print-light')?.id ?? PRINT_THEMES[0]?.id ?? 'print-light';
`;

  await fs.mkdir(path.dirname(outputFile), { recursive: true });
  await fs.writeFile(outputFile, contents, 'utf8');
  console.log(`Wrote ${themes.length} theme(s) to ${outputFile}`);
}

main().catch((err) => {
  console.error(err);
  process.exitCode = 1;
});

